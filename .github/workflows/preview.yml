name: PR Preview

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.dart'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'analysis_options.yaml'
      - '.github/workflows/**'
      - 'android/**'
      - 'ios/**'

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  compute-version:
    name: Compute Version
    runs-on: ubuntu-latest
    outputs:
      build-name: ${{ steps.version.outputs.build-name }}
      build-number: ${{ steps.version.outputs.build-number }}
    steps:
      - uses: actions/checkout@v6

      - name: Compute version
        id: version
        run: |
          BASE_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          BUILD_NUMBER=$(( $(date +%s) / 10 ))

          echo "build-name=${BASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "build-number=${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"

  build:
    name: Build & Deploy Preview
    needs: compute-version
    if: github.event.pull_request.head.repo.full_name == github.repository
    uses: ./.github/workflows/build-deploy.yml
    with:
      build-name: ${{ needs.compute-version.outputs.build-name }}
      build-number: ${{ needs.compute-version.outputs.build-number }}
      flavor: private
      deploy-ios-to: testflight
      deploy-android-to: none
    secrets: inherit

  comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [compute-version, build]
    if: always() && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-build
          message: |
            ## ğŸ“± Preview Build

            | | Details |
            |---|---|
            | **Version** | `${{ needs.compute-version.outputs.build-name }}` (PR #${{ github.event.pull_request.number }}) |
            | **Build** | `${{ needs.compute-version.outputs.build-number }}` |
            | **Status** | ${{ needs.build.result == 'success' && 'âœ… Deployed' || needs.build.result == 'skipped' && 'â­ï¸ Skipped (fork)' || 'âŒ Failed' }} |

            ### Install
            | Platform | Link |
            |----------|------|
            | ğŸ **iOS** | Open **TestFlight** â†’ _MonkeySSH Î²_ â†’ build `${{ needs.compute-version.outputs.build-number }}` |
            | ğŸ¤– **Android (APK)** | ${{ needs.build.result == 'success' && needs.build.outputs.apk-artifact-id != '' && format('[Download APK](https://github.com/{0}/actions/runs/{1}/artifacts/{2})', github.repository, github.run_id, needs.build.outputs.apk-artifact-id) || needs.build.result == 'skipped' && 'N/A (build skipped for fork PR)' || format('[View workflow run](https://github.com/{0}/actions/runs/{1})', github.repository, github.run_id) }} |
            | ğŸ¤– **Android (Play Store)** | [Internal Testing](https://play.google.com/store/apps/details?id=xyz.depollsoft.monkeyssh.private) Â· updates on merge to `main` |

            > Build triggered by ${{ github.event.pull_request.head.sha }}
