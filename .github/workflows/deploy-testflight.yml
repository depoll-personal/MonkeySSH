name: Deploy PR to TestFlight

on:
  workflow_dispatch:
    inputs:
      pr-number:
        description: 'PR number to deploy'
        required: true
        type: string

concurrency:
  group: deploy-testflight-pr-${{ inputs.pr-number }}
  cancel-in-progress: true

jobs:
  compute-version:
    name: Compute Version
    runs-on: ubuntu-latest
    outputs:
      build-name: ${{ steps.version.outputs.build-name }}
      build-number: ${{ steps.version.outputs.build-number }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: refs/pull/${{ inputs.pr-number }}/head

      - name: Compute version
        id: version
        run: |
          BASE_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          BUILD_NUMBER=$(( $(date +%s) / 60 ))

          echo "build-name=${BASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "build-number=${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to TestFlight
    needs: compute-version
    uses: ./.github/workflows/build-deploy.yml
    with:
      build-name: ${{ needs.compute-version.outputs.build-name }}
      build-number: ${{ needs.compute-version.outputs.build-number }}
      flavor: private
      deploy-ios-to: testflight
      deploy-android-to: none
    secrets: inherit
