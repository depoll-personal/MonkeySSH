default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  desc 'Sync certificates and profiles for a given type and app identifier'
  private_lane :sync_certs do |options|
    app_id = options[:app_identifier]
    match_type = options[:type] || 'appstore'

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: false,
    )

    match(
      type: match_type,
      app_identifier: app_id,
      api_key: api_key,
      readonly: true,
    )
  end

  desc 'Setup code signing for CI builds'
  lane :setup_signing do |options|
    app_id = options[:app_identifier] || 'xyz.depollsoft.monkeyssh.private'
    sync_certs(app_identifier: app_id, type: 'appstore')
  end

  desc 'Upload private flavor to TestFlight'
  lane :beta do |options|
    app_id = 'xyz.depollsoft.monkeyssh.private'
    scheme = options[:scheme] || 'Private'
    team_id = '43AWMS3YJX'
    sync_certs(app_identifier: app_id, type: 'appstore')

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: false,
    )

    profile_name = ENV['sigh_xyz.depollsoft.monkeyssh.private_appstore_profile-name'] ||
                   "match AppStore #{app_id}"

    update_code_signing_settings(
      use_automatic_signing: false,
      team_id: team_id,
      code_sign_identity: 'iPhone Distribution',
      profile_name: profile_name,
      bundle_identifier: app_id,
      path: 'Runner.xcodeproj',
      build_configurations: ["Release-#{scheme}"],
    )

    build_app(
      workspace: 'Runner.xcworkspace',
      scheme: scheme,
      configuration: "Release-#{scheme}",
      export_method: 'app-store',
      output_directory: '../build/ios/ipa',
      archive_path: '../build/ios/archive/Runner.xcarchive',
      xcargs: "DEVELOPMENT_TEAM=#{team_id}",
    )

    pilot(
      api_key: api_key,
      app_identifier: app_id,
      ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true,
      skip_submission: true,
    )
  end

  desc 'Upload production flavor to App Store'
  lane :release do |options|
    app_id = 'xyz.depollsoft.monkeyssh'
    scheme = options[:scheme] || 'Production'
    team_id = '43AWMS3YJX'
    sync_certs(app_identifier: app_id, type: 'appstore')

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: false,
    )

    profile_name = ENV['sigh_xyz.depollsoft.monkeyssh_appstore_profile-name'] ||
                   "match AppStore #{app_id}"

    update_code_signing_settings(
      use_automatic_signing: false,
      team_id: team_id,
      code_sign_identity: 'iPhone Distribution',
      profile_name: profile_name,
      bundle_identifier: app_id,
      path: 'Runner.xcodeproj',
      build_configurations: ["Release-#{scheme}"],
    )

    build_app(
      workspace: 'Runner.xcworkspace',
      scheme: scheme,
      configuration: "Release-#{scheme}",
      export_method: 'app-store',
      output_directory: '../build/ios/ipa',
      archive_path: '../build/ios/archive/Runner.xcarchive',
      xcargs: "DEVELOPMENT_TEAM=#{team_id}",
    )

    deliver(
      api_key: api_key,
      app_identifier: app_id,
      ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false,
    )
  end
end
